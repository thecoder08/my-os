#include "io.h"
#include "mem.h"

void setChar(char character, char color, int x, int y) {
    char* cell = (char*) 0x000b8000 + ((y * 80 + x) * 2);
    *cell = character;
    *(cell + 1) = color;
}

void setCursor(int x, int y) {
	short pos = y * 80 + x;
	out(0x3D4, 0x0F);
	out(0x3D5, (char) (pos & 0xFF));
	out(0x3D4, 0x0E);
	out(0x3D5, (char) ((pos >> 8) & 0xFF));
}

void enableCursor(char cursor_start, char cursor_end) {
	out(0x3D4, 0x0A);
	out(0x3D5, (in(0x3D5) & 0xC0) | cursor_start);
 
	out(0x3D4, 0x0B);
	out(0x3D5, (in(0x3D5) & 0xE0) | cursor_end);
}

void disableCursor() {
	out(0x3D4, 0x0A);
	out(0x3D5, 0x20);
}

int currentX = 0;
int currentY = 0;

void clear(char character, char color) {
  for (int i = 0; i < 25; i++){
	  for (int j = 0; j < 80; j++){
		  setChar(character, color, j, i);
	  }
  }
  currentX = 0;
  currentY = 0;
  setCursor(0, 0);
}

void writeChar(char character) {
	if (character == '\r') {
		currentX = 0;
	}
	else if (character == '\n') {
		currentY++;
	}
	else if (character == '\b') {
		currentX--;
	}
	else {
		setChar(character, 0x07, currentX, currentY);
		currentX++;
	}
	if (currentX > 79) {
		currentX = 0;
		currentY++;
	}
	if (currentY > 24) {
		clear(' ', 0x07);
	}
	setCursor(currentX, currentY);
}

void vgaPrint(char* string) {
	for (int i = 0; string[i] != 0; i++) {
		writeChar(string[i]);
	}
}
void setVgaRegister(short port, char index, char data) {
	
}
// mode 1 is 320x200 256 color, mode 0 is 80x25 16 color text
void setVideoMode(int mode) {
	if (mode) {
		in(0x3da);
		out(0x3c0, 0x10);
		out(0x3c0, 0x41);
		out(0x3c0, 0x11);
		out(0x3c0, 0x00);
		out(0x3c0, 0x12);
		out(0x3c0, 0x0f);
		out(0x3c0, 0x13);
		out(0x3c0, 0x00);
		out(0x3c0, 0x14);
		out(0x3c0, 0x00);
		out(0x3c2, 0x63);
		out(0x3c4, 0x01);
		out(0x3c5, 0x01);
		out(0x3c4, 0x03);
		out(0x3c5, 0x00);
		out(0x3c4, 0x04);
		out(0x3c5, 0x0e);
		out(0x3ce, 0x05);
		out(0x3cf, 0x40);
		out(0x3ce, 0x06);
		out(0x3cf, 0x05);
		out(0x3d4, 0x00);
		out(0x3d5, 0x5f);
		out(0x3d4, 0x01);
		out(0x3d5, 0x4f);
		out(0x3d4, 0x02);
		out(0x3d5, 0x50);
		out(0x3d4, 0x03);
		out(0x3d5, 0x82);
		out(0x3d4, 0x04);
		out(0x3d5, 0x54);
		out(0x3d4, 0x05);
		out(0x3d5, 0x80);
		out(0x3d4, 0x06);
		out(0x3d5, 0xbf);
		out(0x3d4, 0x07);
		out(0x3d5, 0x1f);
		out(0x3d4, 0x08);
		out(0x3d5, 0x00);
		out(0x3d4, 0x09);
		out(0x3d5, 0x41);
		out(0x3d4, 0x10);
		out(0x3d5, 0x9c);
		out(0x3d4, 0x11);
		out(0x3d5, 0x8e);
		out(0x3d4, 0x12);
		out(0x3d5, 0x8f);
		out(0x3d4, 0x13);
		out(0x3d5, 0x28);
		out(0x3d4, 0x14);
		out(0x3d5, 0x40);
		out(0x3d4, 0x15);
		out(0x3d5, 0x96);
		out(0x3d4, 0x16);
		out(0x3d5, 0xb9);
		out(0x3d4, 0x17);
		out(0x3d5, 0xa3);
	}
	else {
		in(0x3da);
		out(0x3c0, 0x10);
		out(0x3c0, 0x0C);
		out(0x3c0, 0x11);
		out(0x3c0, 0x00);
		out(0x3c0, 0x12);
		out(0x3c0, 0x0F);
		out(0x3c0, 0x13);
		out(0x3c0, 0x08);
		out(0x3c0, 0x14);
		out(0x3c0, 0x00);
		out(0x3c2, 0x67);
		out(0x3c4, 0x01);
		out(0x3c5, 0x00);
		out(0x3c4, 0x03);
		out(0x3c5, 0x00);
		out(0x3c4, 0x04);
		out(0x3c5, 0x07);
		out(0x3ce, 0x05);
		out(0x3cf, 0x10);
		out(0x3ce, 0x06);
		out(0x3cf, 0x0E);
		out(0x3d4, 0x00);
		out(0x3d5, 0x5f);
		out(0x3d4, 0x01);
		out(0x3d5, 0x4f);
		out(0x3d4, 0x02);
		out(0x3d5, 0x50);
		out(0x3d4, 0x03);
		out(0x3d5, 0x82);
		out(0x3d4, 0x04);
		out(0x3d5, 0x55);
		out(0x3d4, 0x05);
		out(0x3d5, 0x81);
		out(0x3d4, 0x06);
		out(0x3d5, 0xbf);
		out(0x3d4, 0x07);
		out(0x3d5, 0x1f);
		out(0x3d4, 0x08);
		out(0x3d5, 0x00);
		out(0x3d4, 0x09);
		out(0x3d5, 0x4f);
		out(0x3d4, 0x10);
		out(0x3d5, 0x9c);
		out(0x3d4, 0x11);
		out(0x3d5, 0x8e);
		out(0x3d4, 0x12);
		out(0x3d5, 0x8f);
		out(0x3d4, 0x13);
		out(0x3d5, 0x28);
		out(0x3d4, 0x14);
		out(0x3d5, 0x1f);
		out(0x3d4, 0x15);
		out(0x3d5, 0x96);
		out(0x3d4, 0x16);
		out(0x3d5, 0xb9);
		out(0x3d4, 0x17);
		out(0x3d5, 0xa3);
	}
}